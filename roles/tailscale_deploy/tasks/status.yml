---
- name: "tailscale | Wait for Tailscale to be fully connected"
  ansible.builtin.pause:
    seconds: 3

- name: "tailscale | Get Tailscale status"
  ansible.builtin.command: tailscale status
  register: tailscale_status_output
  changed_when: false

- name: "tailscale | Get Tailscale IP address"
  ansible.builtin.command: tailscale ip -4
  register: tailscale_ip_output
  changed_when: false
  failed_when: false

- name: "tailscale | Get detailed Tailscale status (JSON)"
  ansible.builtin.command: tailscale status --json
  register: tailscale_status_json
  changed_when: false
  failed_when: false

- name: "tailscale | Parse Tailscale information"
  ansible.builtin.set_fact:
    tailscale_info: "{{ tailscale_status_json.stdout | from_json }}"
  when: tailscale_status_json.rc == 0

- name: "tailscale | Display Tailscale Status"
  ansible.builtin.debug:
    msg: |
      ============================================
      TAILSCALE DEPLOYMENT SUMMARY
      ============================================
      Hostname: {{ ansible_hostname }}
      System IP: {{ ansible_default_ipv4.address }}
      Tailscale Hostname: {{ computed_hostname }}
      Tailscale IP: {{ tailscale_ip_output.stdout if tailscale_ip_output.rc == 0 else 'N/A' }}
      Status: {{ tailscale_info.BackendState if tailscale_info is defined else 'Unknown' }}
      
      Connected Peers:
      {{ tailscale_status_output.stdout }}
      ============================================

- name: "tailscale | Verify Tailscale is running"
  ansible.builtin.assert:
    that:
      - tailscale_ip_output.rc == 0
      - tailscale_ip_output.stdout | length > 0
    fail_msg: "Tailscale connection verification failed"
    success_msg: "Tailscale is successfully connected and running"

